# Спринт 3

### Грязнов М

### Задание 1

## Задание 1. Анализ и планирование

### 1. Изучите функциональность монолитного приложения

#### Функции

1. Управление отоплением
2. Мониторинг температуры
Реализованы в одном контроллере
Нет авторизации/защиты
Одна БД с 2мя таблицами
Нет ограничений на количество подключений
Сервисы stateless - возможно горизонтальное масштабирование

### 2. Проанализируйте архитектуру монолитного приложения

Язык программирования: Java
База данных: PostgreSQL
Архитектура: Монолитная, все компоненты системы (обработка запросов, бизнес-логика, работа с данными) находятся в рамках одного приложения.
Взаимодействие: Синхронное, запросы обрабатываются последовательно.
Масштабируемость: Ограничена, так как монолит сложно масштабировать по частям.
Развёртывание: Требует остановки всего приложения.

### 3. Определите домены и границы контекстов

Исходя из текущего решения
Домены:

1. Взаимодействия с датчиками(сенсоры)/устройствами(системы) или просто Устройства
Входит как передача команд, так и получение данных с Устройств
2. Управление устройствами или просто Управление
Входит регистрация устройств, удаление устройств, текущее стостояние
Для целевого сценария доемнов больше
3. Установка/Ослуживание устройств или просто Обслуживание
Физическая установка , настрйока, обслуживание/ремонт, снятие устройств

### 4. Проведите анализ архитектуры монолитного приложения

#### Плюсы

1. Простота реализации - все функции в одном файле

#### Возможные проблемы

1. Надежность: Проблемы с сервисом приводят к сбою всей системы
2. Отказоустойчивость: Зависимость от одной СУБД прои нагрузке могут дать замедление/отказ всей системы
3. Простои в обслуживании: происходят с остановкой сервисов (лечится в данном случае просто - балансир + второй инстанс, с БД сложнее, но тоже реализуемо)
4. Безопасность: нет авторизации/аутентификации, работа ведется по ID датчика

### 5.Визуализируйте контекст системы

.docs\SmartHome ASIS Context.puml

## Задание 2. Проектирование микросервисной архитектуры


### Требования
Изложены в задании

### НФТ
Платформа экосистемы готова к подключению до 100 экопоселков по 200 домов по пять устройств в каждом.
это 100 000 устройств.

Предположим, что задержка д.б. не более 1 сек. 



### ! Дисклеймер 1
Комментарии к решению:
Ни где не сказано что такое Стандартный протокол. 
От этого зависит вызывающая сторона, реализация протоколов свзяи.
Варианты:
1. Постоянный пинг от устройства к Серверу на предмет получения новых инструкций. Обычный http rest. 
   Плюсы: простота реализации. Минусы: большинство пустых вызывов или задержки реакции устройств.
2. WebSocket. При включении устройстава происходит соединение с Системой и ожидание команд.
   Плюсы: нет лишней нагрузки на сеть. Минусы: ограничение количества подключений, придется продумывать соответсвующую инфраструктуру.
! Возможно webSocket решает проблем - не достаточно зананий.

1. Постоянное TCP соединение почти аналогично WebSocket
   Плюсы: понижение нагрузки на сеть. Минусы: ограничение количества подключений, нет простой защиты (аутентификация/авторизация).

Выбран вариант 1 для реализации: когда устройство с какой-то периодичностью опрашивает Систему.
Это даст: 
   1. быстрый старт за счет простоты реализации
   2. поддержку большой номенклатуры устройств (публичное api)
   3. упрощенную инфраструктуру на старте
   4. возможность быстро увеличить ресурсы за счет обланых решений
Риски:
   1. нагрузка может рости не предсказуемо/усиленными темпами относительно других решений
   2. задержки при управлении устройствами, получении телеметрии 
   3. дополнительные мощности по обработке сообщений от устройств

RPS:
Каждое устройство раз в секунду "пингует" Систему
100 000 устройств
RPS = 100 000

Потребуется балансировщик и несколько инстансов сервиса Канал. (Сколько - провести НТ).



### ! Дисклеймер 2
Аутентификация устройства 
В вопрос не углубляюсь - предположим, что при первом подключении выдается некий токен, запоминаются характеристики устройства
Вопрос не раскрывается и требует отдельной проработки

### ! Дисклеймер 3
Вопрос действий пратнера не рассматривается

### ! Дисклеймер 4
Вопрос маркетинга не рассматривается

### ! Дисклеймер 5
Сценарии серверного поведения для устройств, которые не поддерживают программирование не расписвыал, но могут быть реализованы в DeviceZooKeeper как отдельный шедуллер с конфиграцией
Конфигурация будет задаваться пользователем в DeviceZooKeeperController




### 1. Декомпозируйте приложение на микросервисы
Субдомены будут представлять из себя Бизнес-сервисы, которые обслуживаются конкретной командой. 
могут состоять из одного или нескольких микросервисов.

Домен - управление устройствами
СубДомены:
1. Канал взаимодействия с Устройствами - DeviceChannel
   Рамки: 
    1. Протокол подключения/управления/Взаимодействия с устройствами
    2. Установка соединения с устройством
    3. Получение показаний  (получение сообщений)
    4. Передача конфигурации (отправка сообщений)
    5. Аутентификация устройства
    6. Текущее состояние связи с устройством
! Важно: обеспечить прием и передачу собщений устройствам без задержек

2. Справочник Устройств - DeviceDictionary
  Рамки:
    1. Карточка устройства
    2. Типы устройств
    3. Возможные настройки
    4. Возможные команды
    5. Периодичность взаимодействия
    6. Регистрация новых типов устройств, изменение действующих
  ! Важно: сразу предсмотреть версионность для поддержки разных версий прошивки устройств

3. Зоопарк устройств - управление действющими устройствами - DeviceZoo
   Рамки:
    1. Обработка сообщений от устройств
    2. Отправка команд/конфигураций стуройствам
    3. Регистрация устройства клиента
    4. Текущие показатели устройства/телеметрии
    5. Конфигурация устрояства
    6. Команды управления устройством
    7. Скрипты/Сценарии управления устройством/Шедуллер

4. Пользователи - Users
    Рамки:
    1. Регистрация
    2. Авторизация/Аутентификация
    3. Права пользователя
    4. Выдача JWT/Проверка JWT
    5. Профиль пользователя

5. Хранилище (Озеро данных/Аудит/Логирование) - HistoryStorage
  Рамки:
   2.1. История по устройствам (история сообщений, ошибки, состояния)
   2.2. История по клиентам (действия, авторизации, аутентификации)
   2.3. Витрины отчетности


### 2. Определите взаимодействия между
Добавлены компоненты:
   1. DeviceChannelBalance - Балансир сообщений от устройств. Должен иметь защиту от DDOS. Ожидает подключения по http/https. Сообщения могут передаваться в открытом виде.
   2. UIApiGateway - Апи шлюз для взаимодействия с внешними потребителями, т.к. пользователи, админы. Выполняет проверку JWT. Ожидает подключение по https. Должно быть настроено SSL.
   3. DataBus - Kasfka, реализация паттерна Event Sourcing в асинхронном режиме распространяет сообщеняи для потребителей. Защиты может не стоять - находится внутри сети, нет доступа из вне. В идеале mTLS
   4. HistoryStorage - отдельная DWH для хранения истории/аудита/формирования отчетности. Технология непонята, можно на первом этапе ELK, но требуются исследования. Самая главная задача разгрузить высоконагруженные сервисы от исторических данных.

Авторизация: RBAC

Основные взаимодействия:
1. Кафка для аснхронных сообщений

.docs\SmartHome TOBE Container.puml

### 3. Визуализируйте архитектуры

#### C4 — Уровень Контекста (Context) 
.docs\SmartHome TOBE Context.puml
#### C4 — Уровень контейнеров (Containers)
.docs\SmartHome TOBE Container.puml
#### C4 — Уровень компонентов (Components)
.docs\SmartHome TOBE Componet Users.puml
.docs\SmartHome TOBE Componet DWH.puml
.docs\SmartHome TOBE Componet DeviceKeeper.puml
.docs\SmartHome TOBE Componet DeviceDictionary.puml
TODO: указать протоколы взаимодействия

#### C4 — Уровень кода (Code).
.docs\SmartHouse TOBE CodeUser&Device.puml
.docs\SmartHouse TOBE DeviceZooKeeper.puml

### 3. Разработка ER-диаграммы
.docs\SmartHouse TOBE ER.puml
Основные  сущности: 
1. Пользователь role
2. Устройство device
3. Комманда deviceCommands
4. Телеметрия deviceTelemetry
5. Сообщение от устройства deviceIncomeMessages
Справочники:
1. Роли  role
2. Типы устройств deviceType
Связи:
1. UserDevices 

!Важно: дома не добавлял - не явдляется важным аттрибутом исходя из требований. Может быть добавлено позже. Ключ к справочнику домов из таблицы связей UserDevices

Краткое описание:
1. Пользователи имеют роли (Админ/пользователь), по которым опредляется доступ к фунциям. 
Совмещение ролей не предусматривается.
2. Пользователи могут иметь много устройств, как и устройства могут управляться несколькими пользователями
3. Устройства имеют Тип, по которому опредляется как управлять устройством и какую телеметрию устройство передает
4. Для устройств создаются комманды (которые отправляются устройству) и фиксируются входящие сообщения телеметрии
5. Для устройств отдельно хранятся текущие показания телеметрии в быстром доступе device.CurrentTelementry, а также последняя активность LastActiveDate (считается, датой передачи телеметрии). 
6. Отдельно выделено deviceIncomeMessages - сообщение не разобранное, может быть телеметрия или иное сообщение.

